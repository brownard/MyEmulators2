<ScriptableScraper>
  <details>
    <name>thegamesdb.net</name>
    <author>Brownard</author>
    <description>Grabs game data from thegamesdb.net</description>
    <id>99999996</id>
    <version major="1" minor="0" point="0"/>
    <published month="2" day="9" year="2012"/>
    <type>MovieDetailsFetcher|MovieCoverFetcher</type>
    <language>en</language>
  </details>

  <action name="search">

    <set name="api_key">
      <![CDATA[f45deae02380f9171ceb6b93db79bb6241109906da7e3dab29b91b6827fea3ee]]>
    </set>
      
    <set name="rx_yearmade">
      <![CDATA[(\d\d\d\d)]]>
    </set>


    <set name="platformLookup">
      <![CDATA[
      |25,3DO|
      |4911,Amiga|
      |23,Arcade|
      |22,Atari 2600|
      |26,Atari 5200|
      |27,Atari 7800|
      |28,Atari Jaguar|
      |29,Atari Jaguar CD|
      |30,Atari XE|
      |31,Colecovision|
      |40,Commodore 64|
      |32,Intellivision|
      |37,Macintosh|
      |14,Xbox|
      |15,Xbox 360|
      |24,NeoGeo|
      |3,Nintendo 64|
      |8,Nintendo DS|
      |7,NES|
      |4,Game Boy|
      |5,Game Boy Advance|
      |41,Game Boy Color|
      |2,GameCube|
      |9,Wii|
      |38,Wii U|
      |1,Windows|
      |33,SEGA 32X|
      |21,SEGA CD|
      |16,Dreamcast|
      |20,Game Gear|
      |18,Genesis|
      |35,SEGA Master System|
      |36,SEGA Mega Drive|
      |17,SEGA Saturn|
      |10,Playstation|
      |11,Playstation 2|
      |12,Playstation 3|
      |39,Playstation Vita|
      |13,PSP|
      |6,SNES|
      |34,TurboGrafx-16|
      ]]>
    </set>

    <set name="rxSearchPlatform"><![CDATA[[|]([^,\n]*),${search.platform}[|]]]></set>
    <parse name="newSearchPlatform" input="${platformLookup}" regex="${rxSearchPlatform}" />
    
    <!-- Retrieve results using Title ${search.system:safe} -->
    <retrieve name="search_page" url="https://api.thegamesdb.net/Games/ByGameName?apikey=${api_key}&amp;name=${search.title:safe}&amp;filter%5Bplatform%5D=${newSearchPlatform[0][0]}" encoding="UTF-8"/>

    <!-- Search result page is used. -->
    <parse name="game_details" input="${search_page}" json="//games" />
    <loop name="curr_details" on="game_details">
      <set name="game[${count}].site_id" value="${game_details[${count}].id}"/>
      <set name="game[${count}].title" value="${game_details[${count}].game_title:htmldecode}"/>

      <parse name="yearmade" input="${game_details[${count}].release_date}" regex="${rx_yearmade}"/>
      <set name="game[${count}].yearmade" value="${yearmade[0][0]}"/>
            
      <set name="game[${count}].system" value="${game_details[${count}].platform}"/>

      <set name="rxPlatformLookup"><![CDATA[[|]${game_details[${count}].platform},([^|]*)[|]]]></set>
      <parse name="newPlatform" input="${platformLookup}" regex="${rxPlatformLookup}" />
      <if test="${newPlatform[0][0]}!=">
        <set name="game[${count}].system" value="${newPlatform[0][0]}"/>
      </if>
      
      <set name="game[${count}].details_url" value="https://api.thegamesdb.net/Games/ByGameID?apikey=${api_key}&amp;id=${game_details[${count}].id}"/>
    </loop>
  </action>

  <action name="get_details">

    <set name="api_key">
      <![CDATA[f45deae02380f9171ceb6b93db79bb6241109906da7e3dab29b91b6827fea3ee]]>
    </set>
      
    <set name="rx_yearmade">
      <![CDATA[(\d\d\d\d)]]>
    </set>
    
    <retrieve name="details_page" url="https://api.thegamesdb.net/Games/ByGameID?apikey=${api_key}&amp;id=${game.site_id}&amp;fields=genres%2Coverview" encoding="UTF-8"/>

    <parse name="game_details" input="${details_page}" json="//games" />
    
    <set name="game.title" value="${game_details[0].game_title}"/>

    <!--<set name="game.company" value="${company[0]:htmldecode}"/>-->

    <parse name="yearmade" input="${game_details[0].release_date}" regex="${rx_yearmade}"/>
    
    <set name="game.yearmade" value="${yearmade[0][0]}"/>

    <set name="game.description" value="${game_details[0].overview:htmldecode}"/>

    <!--<parse name="grade" input="${details_page}" xpath="//Rating"/>
    <set name="game.grade" value="${grade[0]}"/>-->

    <!--<parse name="genre_block" input="${details_page}" xpath="//genre"/>
    <set name="game.genre" value=""/>
    <loop name="currGenre" on="genre_block">
      <set name="game.genre" value="${game.genre}|${currGenre:htmldecode}"/>
    </loop>-->
  </action>

  <action name="get_cover_art">
    
    <set name="api_key">
      <![CDATA[f45deae02380f9171ceb6b93db79bb6241109906da7e3dab29b91b6827fea3ee]]>
    </set>
    
    <if test="${game.site_id}!=">
      <retrieve name="details_page" url="https://api.thegamesdb.net/Games/Images?apikey=${api_key}&amp;games_id=${game.site_id}" encoding="UTF-8"/>
      <parse name="game.baseurl" input="${details_page}" json="//base_url/medium"/>
      <set name="game.baseurl" value="${game.baseurl[0]:htmldecode}"/>
      
      <parse name="images" input="${details_page}" json="//images/child::*"/>
      <set name="game.images" value=""/>
      <loop name="image" on="images" limit="100">
        <if test="${images[${count}].side}=front">
          <set name="game.images" value="${game.images}|${images[${count}].filename:htmldecode}"/>
        </if>
        <if test="${images[${count}].side}=back">
          <set name="game.images" value="${game.images}|${images[${count}].filename:htmldecode}"/>
        </if>
      </loop>
    </if>
  </action>

  <action name="get_screenshots">
    <set name="api_key">
      <![CDATA[f45deae02380f9171ceb6b93db79bb6241109906da7e3dab29b91b6827fea3ee]]>
    </set>
    
    <if test="${game.site_id}!=">
      <retrieve name="details_page" url="https://api.thegamesdb.net/Games/Images?apikey=${api_key}&amp;games_id=${game.site_id}" encoding="UTF-8"/>
      <parse name="game.baseurl" input="${details_page}" json="//base_url/medium"/>
      <set name="game.baseurl" value="${game.baseurl[0]:htmldecode}"/>
      
      <parse name="images" input="${details_page}" json="//images/child::*"/>
      <set name="game.images" value=""/>
      <loop name="image" on="images" limit="100">
        <if test="${images[${count}].type}=screenshot">
          <set name="game.images" value="${game.images}|${images[${count}].filename:htmldecode}"/>
        </if>
      </loop>
    </if>
  </action>

  <action name="get_fanart">
    <set name="api_key">
      <![CDATA[f45deae02380f9171ceb6b93db79bb6241109906da7e3dab29b91b6827fea3ee]]>
    </set>
    
    <if test="${game.site_id}!=">
      <retrieve name="details_page" url="https://api.thegamesdb.net/Games/Images?apikey=${api_key}&amp;games_id=${game.site_id}" encoding="UTF-8"/>
      <parse name="game.baseurl" input="${details_page}" json="//base_url/medium"/>
      <set name="game.baseurl" value="${game.baseurl[0]:htmldecode}"/>
      
      <parse name="images" input="${details_page}" json="//images/child::*"/>
      <set name="game.images" value=""/>
      <loop name="image" on="images" limit="100">
        <if test="${images[${count}].type}=fanart">
          <set name="game.images" value="${game.images}|${images[${count}].filename:htmldecode}"/>
        </if>
      </loop>
    </if>
  </action>
</ScriptableScraper>


